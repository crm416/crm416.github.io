<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <meta name="description" content="Charlie Marsh is a programmer and student at Princeton University with major interests in functional programming and machine learning.">
  <meta name="viewport" content="width=device-width">

  <!-- Use title if it's in the page YAML frontmatter -->
  <title>True parallelism in OCaml
 | Charlie Marsh</title>
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link href="../static/css/combined.css" rel="stylesheet" type="text/css" />
  <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?lang=ml"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36552582-2', 'princeton.edu');
  ga('send', 'pageview');
  </script>
</head>

<body class="index">
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span2 hidden-phone">
        <header>
          <h1 style="font-size:50px"><a class="blank" href="/~crmarsh/">Charlie Marsh</a></h1>
          <p><a class="implicit" href="/~crmarsh/">Home</a> &sdot; <a class="implicit" href="../about.html">About Me</a></p>
          <h2>Programmer, student.</h2>
          <p>I'm into functional programming,<br /> machine learning,<br /> and other fun stuff.<p>
            <p>Find me on:</p>
          </header>
          <a href="mailto:crmarsh@princeton.edu" class="nav email"></a>
          <a href="http://www.github.com/crm416" class="nav github"></a>
          <a href="http://stackoverflow.com/users/1450892/charles-marsh" class="nav stackoverflow"></a>
          <a href="http://uk.linkedin.com/in/marshcharles" class="nav linkedin"></a>
        </div>
        <div class="span2 visible-phone">
          <div>
            <p style="font-size:25px"><a class="blank" href="/~crmarsh/">Charlie Marsh</a>  <div style="margin-top:-10px"><code class="custom"><span class="code_red">type</span> <span class="code_blue">blog</span></code></div></p>
          </div>
          <hr />
        </div>
        <div class="span9 offset1">
          <h1>True parallelism in OCaml</h1>

<p>OCaml provides a nice <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/libref/Thread.html">library for multi-threading</a>. Problem is, according to my professor, under the hood, <strong>OCaml doesn't actually employ any parallelism at all!</strong> In truth, the compiler just interleaves instructions in a way that has the same computational effect as multi-threading, barring the 2x speed-up.</p>

<p>On the side, I've been working on an alternative to the small Futures module we used in class. Futures are very similar to threads but safer and easier to use. The interface itself is composed of a <strong>create</strong> method, which takes as argument an expression to compute and performs said computation on a new thread; as well as a <strong>force</strong> method, which blocks the main thread until the Future has finished its computation.</p>

<h2>Processes</h2>

<p>This alternative aims to operate at a lower level than would typically be done in OCaml and circumvent the language's lack of true multi-threading. To do so, it runs the desired computation on a separate UNIX process using some of <a href="http://ocamlunix.forge.ocamlcore.org">these features</a>. <strong>Rather than trying to run two programs from within the same process, then, it seeks to run a single program, in two separate processes.</strong></p>

<h2>Preserving Type Safety</h2>

<p>One difficulty that I encountered along the way was preserving type-safety. To transfer information from the forked thread to the main thread (i.e., to return the result of the Future's computation), I use the <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Marshal.html">Marshal module</a>, which allows you to encode arbitrary data structures as sequences of bytes. However, the documentation includes the following, essential warning: <strong>Warning: marshaling is currently not type-safe</strong>. In reality, if you're trying to Marshall some expression <em>e</em> of type <em>'a</em>, you need to somehow pass type <em>'a</em> to the output function. That is, the Marshal module needs to know the output type of the data it's trying to decode. To handle that, I had to strictly enforce the type of the output computation as follows:</p>

<pre><code class="prettyprint lang-ml">let future (f:'a -&gt; 'b) (x:'a) : 'b future =
...
    let result : 'b = Marshal.from_channel (in_channel_of_descr fd_in) in
    ...
</code></pre>

<p>Notice that type <em>'b</em>, the desired output of the function <em>f</em>, is explicitly enforced as the output of the Marshal operation.</p>

<h2>Thread Pools</h2>

<p>One issue: I haven't gotten around to implementing a <a href="http://en.wikipedia.org/wiki/Thread_pool_pattern">thread pool</a> for the Futures module. That is, if you run some massive computation that requires too many threads, you run into all sorts of errors. On my machine, running the <em>Mergesort</em> demo with a list of size 1000 results in a crash (this seems to be roughly the threshold).</p>

<p>Besides that, the package seems to be working, and the speed-up approaches 2x as I increase the size of the input to various functions. Give it a try: all the code is on <a href="https://github.com/crm416/ocaml-futures">GitHub</a>.</p>

<p class="date">Posted on January 17, 2013.</p>

          <div id="disqus_thread"></div>
          <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'crmarsh416'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
  </div>
</body>
</html>