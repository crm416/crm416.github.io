<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <meta name="description" content="Charlie Marsh is a programmer and student at Princeton University with major interests in functional programming and machine learning.">
  <meta name="viewport" content="width=device-width">
  <title>PhantomJS: Common Gotchas for Beginners
 | Charlie Marsh</title>
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link href="http://crmarsh416.appspot.com/css/combined.css" rel="stylesheet" type="text/css" />
  <link href='https://plus.google.com/u/0/100601164815113053596/' rel='author'>
  <script type="text/javascript" src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?lang=ml"></script>
  <script type="text/javascript" data-no-instant>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-36552582-2', 'princeton.edu');
    InstantClick.on('change', function() {
      ga('send', 'pageview', location.pathname + location.search);
    });
    InstantClick.init();
  </script>
</head>

<body class="index">
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span2 hidden-phone"></div>
      <div class="span2 hidden-phone" style="position:fixed">
          <h1 style="font-size:50px"><a class="blank" href="/~crmarsh/">Charlie<br>Marsh</a></h1>
          <p><a class="implicit" href="/~crmarsh/" data-instant>Home</a> &sdot; <a class="implicit" href="../Charles_Marsh_CV.pdf">CV</a>&sdot; <a class="implicit" href="../about.html">About</a></p>
          <h2>Programmer,<br>student.</h2>
          <p>I'm into functional<br>programming,<br>machine learning,<br> and other fun stuff.<p>
            <p>Find me on:</p>
          <a href="mailto:crmarsh@princeton.edu" class="nav email"></a>
          <a href="http://www.github.com/crm416" class="nav github"></a>
          <a href="http://stackoverflow.com/users/1450892/charles-marsh" class="nav stackoverflow"></a>
          <a href="http://uk.linkedin.com/in/marshcharles" class="nav linkedin"></a>
        </div>
        <div class="span2 visible-phone">
          <div>
            <p style="font-size:25px"><a class="blank" href="/~crmarsh/">Charlie Marsh</a>  <div style="margin-top:-10px"><code class="custom"><span class="code_red">type</span> <span class="code_blue">blog</span></code></div>
          </div>
          <hr />
        </div>
        <div class="span9 offset1" style="padding-left:20px">
          <h1>PhantomJS: Common Gotchas for Beginners</h1>
<a class="btn btn-primary" href="http://twitter.com/intent/tweet?url=http://www.princeton.edu/~crmarsh/phantomjs&text=PhantomJS: Common Gotchas for Beginners
&via=crm416">Tweet</a> | <a class="btn btn-primary" href="http://facebook.com/sharer.php?u=http://www.princeton.edu/~crmarsh/phantomjs">Like</a> | <a class="btn btn-primary" href="https://plus.google.com/share?url=http%3A%2F%2Fwww.princeton.edu/~crmarsh/phantomjs">+1</a>

<p>Over the summer, I had a pet project to automate <a href="https://github.com/geuis/helium-css">Helium.js</a>, a tool for identifying unused style elements in your CSS. Currently, in order to generate a Helium report, you need to add some JavaScript to your webpage, open up your web browser, navigate to the page, and click some buttons.</p>

<p>My goal was to automate the process using a headless browser <em>(that is, a browser that runs without a GUI, allowing you to navigate the web and interact with web pages from your terminal)</em>. In this case, I chose to use <a href="http://phantomjs.org">PhantomJS</a>, a tool designed designed precisely for this use-case.</p>

<p><em>(Note: the aforementioned project is still under active development and not yet available on GitHub.)</em></p>

<p>I had a mixed experience. Headless browsing is notoriously difficult to debug, and this case was no different: errors were tough to reproduce, results were inconsistent, and producing informative output was challenging.</p>

<p>Once I got past the initial difficulties, however, PhantomJS was actually a pretty powerful toolâ€”hats off to the creators, as always.</p>

<p>In this post, I'd like to describe some of the common "gotchas" that I've found associated with PhantomJS (I call them "common" due to: 1. my own experience, and 2. finding similar questions/issues documented on StackOverflow), along with their solutions.</p>

<p><em>Note: that PhantomJS is often used in tandem with <a href="http://casperjs.org">CasperJS</a>; it's possible that some of what follows is made easier with Casper, namely, navigating webpages. But I think these gotchas are still valid, even in the face of Casper.</em></p>

<h2>Code Context</h2>

<p>Perhaps the first gotcha is that there are really two contexts in your PhantomJS program: firstly, the PhantomJS program itself; secondly, the webpage open in your headless browser, i.e., access to the DOM. (This is important for subsequent gotchas.)</p>

<p>What's the difference? Well, the PhantomJS code you write is used to control your browser automation at a high level. Think of it as the user of your browser. It can open up a webpage, save things to the filesystem, etc. However, any JavaScript that's executed in the actual webpage (i.e., interacting with the DOM) is a whole world of its own. In this sense, the PhantomJS program is <a href="https://github.com/ariya/phantomjs/wiki/Quick-Start#code-evaluation">"sandboxed"</a>.</p>

<p>A litmus test: if you're using jQuery, you're in the latter context.</p>

<h2>Page.evaluate</h2>

<p>With that in mind, one of the first questions that I asked myself, when using PhantomJS: "How can I execute JavaScript <em>on</em> the given webpage itself?" In other words, I wanted to somehow mess around with the webpage using jQuery, and I couldn't figure out how to actually execute code in the context of the page.</p>

<p>The <a href="https://github.com/ariya/phantomjs/wiki/Quick-Start#code-evaluation">solution</a>: <code class="prettyprint">page.evaluate</code> (where <code class="prettyprint">page</code> is the variable representing the current page "open" in your headless browser).</p>

<p><code class="prettyprint">page.evaluate</code> takes, as argument, a function to-be executed in the context of the webpage. This is incredibly useful. Further, <code class="prettyprint">page.evaluate</code> can return a result from the webpage back to your PhantomJS program. Say, for example, that you'd like to grab the text of an element on the current page with ID "foo":</p>

<pre><code class="prettyprint">var foo = page.evaluate(function() {
    return $("#foo").text;
})
</code></pre>

<p>You could then use <code class="prettyprint">foo</code> in your PhantomJS program, successfully extracting the value from the webpage. <em>Note: return values are limited to simple objects, rather than, say, functions.</em></p>

<h2>IncludeJs and InjectJs</h2>

<p>Actually, the code snippet above might not work as expected. I'll repeat it here for clarity:</p>

<pre><code class="prettyprint">var foo = page.evaluate(function() {
    return $("#foo").text;
})
</code></pre>

<p>The problem? The active webpage might not have jQuery loaded.</p>

<p>Luckily, you can use PhantomJS to inject/include JavaScript files in the current webpage using two functions: <code class="prettyprint">page.injectJs</code> and <code class="prettyprint">page.includeJs</code>. The difference between the two is quite nuanced. There's a good discussion <a href="https://groups.google.com/forum/#!topic/phantomjs/G4xcnSLrMw8">here</a> for those interested, but essentially, <code class="prettyprint">page.injectJs</code> pauses execution until the script is loaded, while <code class="prettyprint">page.includeJs</code> loads the script like any other. <em>Note: both accept callbacks.</em></p>

<p>Here's the revised code (credit to the <a href="https://github.com/ariya/phantomjs/wiki/Page-Automation">PhantomJS docs</a>):</p>

<pre><code class="prettyprint">page.includeJs("http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js", function() {
    var foo = page.evaluate(function() {
        return $("#foo").text;
    });
    // do what you gotta do with 'foo'
    // ...
});
</code></pre>

<h2>Console.logging from your web browser</h2>

<p>Similarly, I was often frustrated by the inability to display information logged by my webpage. Recall the split between the context of your PhantomJS program and the webpage open in your headless browser. Well, if you type <code class="prettyprint">console.log("Hello, World!")</code> in your PhantomJS program, that will be printed to your terminal. If, however, your webpage tries to log the same message, it will pass by unnoticed! So if your webpage prints a bunch of traces to the console, you'll never see 'em.</p>

<p>Specifically, <strong>the following code does nothing</strong> because "Hello, World!" is printed in the context of the browser:</p>

<pre><code class="prettyprint">page.evaluate(function() {
    console.log("Hello, World!")
})
</code></pre>

<p>So, what if you want to log messages to your terminal from within your webpage? The trick is to use the <code class="prettyprint">page.onConsoleMessage</code> event and echo any messages printed in the browser out to your terminal. Try this:</p>

<pre><code class="prettyprint">page.onConsoleMessage = function(msg){
    console.log(msg);
};
</code></pre>

<p>For more, see my <a href="http://stackoverflow.com/questions/18115888/phantomjs-not-returning-results/18131369#18131369">StackOverflow answer</a>.</p>

<h2>waitFor.js</h2>

<p>PhantomJS beginners constantly ask how they can wait for something to appear on their webpage before acting. For example, maybe they want a banner to appear and then extract some text from it. Say "#foo" is now a div that loads a few seconds after the page has appeared. If you simply use the following code, you'll get unexpected results, as the banner may not be loaded at the time of query:</p>

<pre><code class="prettyprint">var page = require('webpage').create();
page.open('http://www.sample.com', function() {
    var foo = page.evaluate(function() {
        return $("#foo").text;
    });
    // ...
    phantom.exit();
});
</code></pre>

<p>Instead, you should use <a href="https://github.com/ariya/phantomjs/blob/master/examples/waitfor.js">waitFor.js</a>, a nice JavaScript snippet provided by the PhantomJS guys. This function is pretty simple, but very, very useful. Essentially, it queries the page every few seconds (the exact interval is an optional parameter), executing a user-specified function when a certain condition has been met. Expanding on the previous example, our code might look like the following (excluding the lengthy definition of <a href="https://github.com/ariya/phantomjs/blob/master/examples/waitfor.js">waitFor</a>):</p>

<pre><code class="prettyprint">var page = require('webpage').create();
page.open('http://www.sample.com', function() {
    waitFor(function() {
            // Check in the page if a specific element is now visible
            return page.evaluate(function() {
                return $("#foo").is(":visible");
            });
        }, function() {
           var foo = page.evaluate(function() {
                return $("#foo").text;
            });
            // ...
            phantom.exit();
        });   
    });
});
</code></pre>

<h2>Going Forward</h2>

<p>There's a lot more to PhantomJS than I've managed to go through in this post. And I'm personally excited to check out CasperJS at some point in the future, which seems great as well (in particular, for unit testing). But hopefully the tips and gotchas described in this post can be helpful for beginners.</p>

          <p class="date">Posted on September 13, 2013.<p>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
              var disqus_shortname = 'crmarsh416';
              (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            <br><br>
            <hr />
            <center>
              &copy; 2014 Charles Marsh
              <a href="feed.xml" style="padding-bottom:15px">
                <img class="icon" src="http://crmarsh416.appspot.com/img/rss.png">
              </a>
            </center>
          </div>
        </div>
      </div>
    <script src="http://crmarsh416.appspot.com/js/instantclick.min.js" data-no-instant></script>
    <script data-no-instant>InstantClick.init();</script>
    </body>
    </html>